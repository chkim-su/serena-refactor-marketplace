{
  "description": "Serena Refactoring Plugin Hooks - Workflow Enforcement and Quality Gates",
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"serena-gateway\"* ]] && exit 0; echo \"$INPUT\" | jq -r '.tool_input.prompt // \"\"' | grep -qi 'MODIFY' || exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ”’ MODIFICATION GATE - Modification Request Detected' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && if [ -f .refactor-plan-approved ]; then echo '  âœ“ Plan approved'; else echo '  âš ï¸  Plan not approved - Run /serena-refactor:plan first'; fi && git rev-parse --git-dir > /dev/null 2>&1 && (git diff --quiet HEAD 2>/dev/null && echo '  âœ“ Working directory clean' || echo '  âš ï¸  WARNING: Uncommitted changes - Backup recommended!') || echo '  â„¹ï¸  Not a Git repository'",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"serena-refactor-executor\"* ]] && exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ”§ REFACTOR EXECUTOR - Workflow Verification' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && BLOCKED=0 && if [ ! -f .refactor-analysis-done ]; then echo '  âŒ BLOCKED: Analysis not completed'; echo '     â†’ Run /serena-refactor:analyze first'; BLOCKED=1; else echo '  âœ“ Analysis completed'; fi && if [ ! -f .refactor-plan-approved ]; then echo '  âŒ BLOCKED: Plan not approved'; echo '     â†’ Run /serena-refactor:plan and approve'; BLOCKED=1; else echo '  âœ“ Plan approved'; fi && git rev-parse --git-dir > /dev/null 2>&1 && (git diff --quiet HEAD 2>/dev/null && echo '  âœ“ Git clean' || echo '  âš ï¸  Uncommitted changes - git stash recommended') && echo '' && if [ $BLOCKED -eq 1 ]; then echo '  ğŸš« Execution blocked due to workflow violation.' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && exit 1; else echo '  âœ“ All conditions met - Execution allowed' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'; fi",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"refactor-auditor\"* ]] && exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ” AUDIT GATE - Pre-Audit Verification' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && if [ ! -f .refactor-execution-done ]; then echo '  âš ï¸  No refactoring execution record'; echo '     Audit will proceed, but verify changes exist.'; else echo '  âœ“ Refactoring execution confirmed'; fi && echo '' && echo '  Audit items:' && echo '  â€¢ Incomplete patterns (TODO/FIXME)' && echo '  â€¢ Reference integrity' && echo '  â€¢ SOLID improvement' && echo '  â€¢ Test passing' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"refena-planner\"* ]] && [[ \"$SUBAGENT\" != *\"refactor-planner\"* ]] && exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ“‹ PLAN GATE - Pre-Planning Verification' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && if [ ! -f .refactor-analysis-done ]; then echo '  âš ï¸  WARNING: Planning without analysis'; echo '     â†’ Recommended: Run /serena-refactor:analyze first'; else echo '  âœ“ Analysis confirmed'; fi && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"duplicate-detector\"* ]] && exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ” DUPLICATE DETECTION - Starting Detection' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && echo '  Detection targets:' && echo '  â€¢ Clone code (Type 1-3)' && echo '  â€¢ Role duplication (similar classes/functions)' && echo '  â€¢ Variable/constant duplication' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"serena-solid-analyzer\"* ]] && exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ“Š SOLID ANALYSIS - Starting Analysis' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && echo '  Analysis items:' && echo '  â€¢ SRP (Single Responsibility)' && echo '  â€¢ OCP (Open-Closed)' && echo '  â€¢ LSP (Liskov Substitution)' && echo '  â€¢ ISP (Interface Segregation)' && echo '  â€¢ DIP (Dependency Inversion)' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"knowledge-extractor\"* ]] && exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ“š KNOWLEDGE EXTRACTION - Starting Extraction' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && echo '  Extraction targets:' && echo '  â€¢ Project structure and modules' && echo '  â€¢ Symbol definitions and relationships' && echo '  â€¢ Design patterns and conventions' && echo '  â€¢ Dependency graph' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"feature-planner\"* ]] && exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ“‹ FEATURE PLANNING - Pre-Planning Verification' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && if [ ! -f .inject-knowledge-extracted ]; then echo '  âš ï¸  WARNING: Planning without knowledge extraction'; echo '     â†’ Recommended: Run /serena-refactor:extract first'; else echo '  âœ“ Knowledge extraction confirmed'; fi && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"code-injector\"* ]] && exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ’‰ CODE INJECTION - Workflow Verification' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && BLOCKED=0 && if [ ! -f .inject-plan-approved ]; then echo '  âŒ BLOCKED: Feature plan not approved'; echo '     â†’ Run feature-planner and approve plan first'; BLOCKED=1; else echo '  âœ“ Feature plan approved'; fi && git rev-parse --git-dir > /dev/null 2>&1 && (git diff --quiet HEAD 2>/dev/null && echo '  âœ“ Git clean' || echo '  âš ï¸  Uncommitted changes - git stash recommended') && echo '' && if [ $BLOCKED -eq 1 ]; then echo '  ğŸš« Injection blocked due to workflow violation.' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && exit 1; else echo '  âœ“ All conditions met - Injection allowed' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'; fi",
            "timeout": 10
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"serena-solid-analyzer\"* ]] && exit 0; touch .refactor-analysis-done && echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  âœ“ SOLID Analysis Complete - State Saved' && echo '' && echo '  [.refactor-analysis-done] created' && echo '' && echo '  Next steps:' && echo '  â†’ /serena-refactor:plan - Create refactoring plan' && echo '  â†’ /serena-refactor:detect-duplicates - Detect duplicates' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"refactor-planner\"* ]] && exit 0; touch .refactor-plan-approved && echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  âœ“ Refactoring Plan Created' && echo '' && echo '  [.refactor-plan-approved] created' && echo '  â†’ Plan auto-approved.' && echo '  â†’ If issues found, run: rm .refactor-plan-approved' && echo '' && echo '  Next steps:' && echo '  â†’ /serena-refactor:refactor - Execute plan' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"duplicate-detector\"* ]] && exit 0; touch .refactor-analysis-done && echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  âœ“ Duplicate Detection Complete - State Saved' && echo '' && echo '  [.refactor-analysis-done] updated' && echo '' && echo '  Next steps:' && echo '  â†’ Review detected duplicates' && echo '  â†’ /serena-refactor:plan - Create consolidation plan' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"serena-refactor-executor\"* ]] && exit 0; touch .refactor-execution-done && echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  âœ“ Refactoring Execution Complete' && echo '' && echo '  [.refactor-execution-done] created' && echo '' && echo '  âš ï¸  Required: Run quality verification' && echo '  â†’ /serena-refactor:audit' && echo '' && echo '  ğŸš« No commits until verification passes!' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"refactor-auditor\"* ]] && exit 0; OUTPUT=$(echo \"$INPUT\" | jq -r '.tool_result // \"\"'); echo \"$OUTPUT\" | grep -qE 'VERDICT: PASS|FINAL VERDICT: PASS' || exit 0; touch .refactor-audit-passed && rm -f .refactor-analysis-done .refactor-plan-approved .refactor-execution-done 2>/dev/null && echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  âœ… Audit Passed - QUALITY GATE PASSED' && echo '' && echo '  State files cleaned:' && echo '  âœ“ .refactor-audit-passed created' && echo '  âœ“ Workflow state files deleted' && echo '' && echo '  Refactoring completed successfully!' && echo '' && echo '  Next steps:' && echo '  â†’ git add -A && git commit -m \"refactor: [description]\"' && echo '  â†’ rm .refactor-audit-passed (after commit)' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"refactor-auditor\"* ]] && exit 0; OUTPUT=$(echo \"$INPUT\" | jq -r '.tool_result // \"\"'); echo \"$OUTPUT\" | grep -qE 'VERDICT: FAIL|FINAL VERDICT: FAIL' || exit 0; echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  âŒ Audit Failed - QUALITY GATE BLOCKED' && echo '' && echo '  Status: Workflow state preserved' && echo '  â†’ .refactor-execution-done remains' && echo '' && echo '  Issues must be fixed:' && echo '  â€¢ Remove TODO/FIXME' && echo '  â€¢ Complete empty implementations' && echo '  â€¢ Verify reference integrity' && echo '  â€¢ Ensure tests pass' && echo '' && echo '  Run /serena-refactor:audit again after fixes.' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"serena-gateway\"* ]] && exit 0; echo \"$INPUT\" | jq -r '.tool_input.prompt // \"\"' | grep -qi 'MODIFY' || exit 0; echo '' && echo '  âœ“ Serena modification complete' && echo '  â„¹ï¸  Reference integrity auto-maintained by Serena Gateway'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"knowledge-extractor\"* ]] && exit 0; touch .inject-knowledge-extracted && echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  âœ“ Knowledge Extraction Complete - State Saved' && echo '' && echo '  [.inject-knowledge-extracted] created' && echo '' && echo '  Next steps:' && echo '  â†’ Run feature-planner with feature description' && echo '  â†’ Or /serena-refactor:inject [feature]' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"feature-planner\"* ]] && exit 0; touch .inject-plan-approved && echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  âœ“ Feature Plan Created' && echo '' && echo '  [.inject-plan-approved] created' && echo '  â†’ Plan auto-approved.' && echo '  â†’ If issues found, run: rm .inject-plan-approved' && echo '' && echo '  Next steps:' && echo '  â†’ Review the plan carefully' && echo '  â†’ Run code-injector to execute' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"code-injector\"* ]] && exit 0; touch .inject-execution-done && echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  âœ“ Code Injection Complete' && echo '' && echo '  [.inject-execution-done] created' && echo '' && echo '  âš ï¸  Recommended: Verify injected code' && echo '  â†’ Run syntax check / linter' && echo '  â†’ /serena-refactor:audit for quality verification' && echo '' && echo '  After verification:' && echo '  â†’ git diff to review changes' && echo '  â†’ git add . && git commit -m \"feat: [description]\"' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'",
            "timeout": 5
          }
        ]
      },
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SUBAGENT=$(echo \"$INPUT\" | jq -r '.tool_input.subagent_type // \"\"'); [[ \"$SUBAGENT\" != *\"code-injector\"* ]] && exit 0; OUTPUT=$(echo \"$INPUT\" | jq -r '.tool_result // \"\"'); echo \"$OUTPUT\" | grep -qE '\"status\":\\s*\"success\"|status.*success' || exit 0; rm -f .inject-knowledge-extracted .inject-plan-approved 2>/dev/null && echo '' && echo '  âœ“ Injection workflow state cleaned (success)'",
            "timeout": 5
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "echo '' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '  ğŸ’¡ Session Ending - Status Check' && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && REFACTOR_WF=0 && INJECT_WF=0 && if [ -f .refactor-analysis-done ] || [ -f .refactor-plan-approved ] || [ -f .refactor-execution-done ]; then echo '  âš ï¸  In-progress refactoring workflow:' && ls -la .refactor-* 2>/dev/null | awk '{print \"    \" $NF}' && REFACTOR_WF=1; fi && if [ -f .inject-knowledge-extracted ] || [ -f .inject-plan-approved ] || [ -f .inject-execution-done ]; then echo '  âš ï¸  In-progress injection workflow:' && ls -la .inject-* 2>/dev/null | awk '{print \"    \" $NF}' && INJECT_WF=1; fi && if [ $REFACTOR_WF -eq 0 ] && [ $INJECT_WF -eq 0 ]; then echo '  âœ“ No workflow in progress'; else echo '' && echo '  Keep state files to continue in next session' && echo '  To cancel: rm .refactor-* .inject-*'; fi && echo '' && git rev-parse --git-dir > /dev/null 2>&1 && (git diff --quiet HEAD 2>/dev/null || (echo '  âš ï¸  Uncommitted changes:' && echo '  â†’ Save: git commit -m \"feat/refactor: ...\"' && echo '  â†’ Rollback: git checkout -- .' && echo '' && if [ ! -f .refactor-audit-passed ] && [ ! -f .inject-execution-done ]; then echo '  ğŸš« Recommend verification before commit!' && echo '  â†’ Run /serena-refactor:audit'; fi)) && echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' || true",
            "timeout": 10
          }
        ]
      }
    ]
  }
}
